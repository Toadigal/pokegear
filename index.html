<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PokÃ©mon Randomizer â€” Love Ball PokÃ©gear (ver.10.2)</title>
<style>
:root{
  /* palette (editable via UI editor) */
  --blush: #f7bfd6;         /* wallpaper base */
  --accent: #ff6aa6;        /* love accent */
  --gear-shell: #dff6ff;    /* pokÃ©gear shell */
  --gear-blue: #4ea8ff;
  --card-bg: #fffafc;
  --shadow: 0 28px 72px rgba(40,30,80,0.18);
  --placeholder-silhouette: #e9d4de;

  /* wallpaper pattern controls */
  --dot-size: 40px;
  --dot-offset: 85px;
  --wallpaper-opacity: 1;

  /* UI sizing */
  --device-width: 1120px;
  --device-height: 1200px;
  --screen-padding: 22px;
  --border-radius: 34px;
  --font-base: 16px;
}

/* global reset & base */
html,body{height:100%;margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;font-size:var(--font-base);}
body{
  display:flex;align-items:center;justify-content:center;padding:22px;
  background:var(--blush);
  background-image:
    url("https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/love-ball.png"),
    url("https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png"),
    url("https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/heal-ball.png"),
    url("https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/luxury-ball.png");
  background-repeat: repeat;
  background-size: var(--dot-size) var(--dot-size), var(--dot-size) var(--dot-size), var(--dot-size) var(--dot-size), var(--dot-size) var(--dot-size);
  background-position: 0 0, var(--dot-offset) var(--dot-offset), 0 var(--dot-offset), var(--dot-offset) 0;
  opacity: var(--wallpaper-opacity);
}

/* device */
.device {
  width: var(--device-width); max-width:96vw;
  height: var(--device-height); max-height:94vh;
  border-radius: var(--border-radius);
  background: linear-gradient(180deg,var(--gear-shell),#cfeaff);
  box-shadow: var(--shadow);
  border: 6px solid rgba(255,255,255,0.85);
  display:flex;flex-direction:column;align-items:center;padding:20px;position:relative;
}

/* status/header */
.status { width:100%; display:flex; align-items:center; justify-content:space-between; padding:8px 14px; box-sizing:border-box; color:#083e6b; font-weight:900;}
.status .left{display:flex;align-items:center;gap:10px;font-size:15px;}
.signal{display:flex;gap:4px;align-items:center;}
.dot{width:8px;height:8px;border-radius:50%;}
.dot.t1{background:#ffd7e8;} .dot.t2{background:#ffeaf5;} .dot.t3{background:#fff;}
.battery{width:48px;height:18px;border-radius:4px;border:2px solid #083e6b;display:flex;align-items:center;padding:2px 4px;box-sizing:border-box;}
.bat-level{height:8px;border-radius:2px;background:linear-gradient(90deg,#ff86bf,#ff5ca5);flex:1;}

/* screen */
.screen {
  margin-top:10px;
  background: linear-gradient(180deg,var(--card-bg),#fff);
  border-radius:20px;
  width: calc(100% - 56px);
  height: calc(100% - 220px);
  display:flex; align-items:flex-start; justify-content:center;
  padding:var(--screen-padding); box-sizing:border-box; border: 3px solid rgba(255,255,255,0.85);
  overflow:auto; -webkit-overflow-scrolling:touch;
}

/* main card */
.pokemon-card { width: 680px; max-width:96%; background:white; border-radius:16px; padding:20px; box-shadow: 0 12px 34px rgba(0,0,0,0.08); border: 2px solid rgba(255,230,240,0.9); text-align:center; }
.device-title{margin:0;font-size:20px;color:#083e6b;font-weight:900;}
.controls{margin-top:12px; display:flex; gap:12px; align-items:center; justify-content:center;}
select,button{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,220,230,0.95); background:#fff; font-size:14px;}
button.generate{background:linear-gradient(180deg,var(--accent),#ff4b8f); color:white; border:none; cursor:pointer; font-weight:900; box-shadow:0 10px 24px rgba(255,90,140,0.12);}
button.generate:hover{transform:translateY(-2px);}

/* images & badges */
.images{display:flex;align-items:center;justify-content:center;gap:14px;margin-top:14px;}
.images img{width:192px;height:192px;object-fit:contain; image-rendering:pixelated;border-radius:12px;background:transparent;}
.small-img{width:104px;height:104px;border-radius:10px;}
.generation-badge{display:inline-block;background:linear-gradient(135deg,#ff9ac9,#ff6aa6); color:white;padding:8px 14px;border-radius:16px;font-weight:900;margin-top:12px;}

/* info */
.info{text-align:left;margin-top:14px;padding:0 6px;}
.types{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;}
.type{background:#fff3f8;border-radius:10px;padding:6px 10px;border:1px solid #ffcfe0;text-transform:capitalize;font-weight:800;color:#5b2d4a;}
.dex-entry{font-style:italic;margin-top:10px;color:#444;}

/* evolutions & forms */
.evolutions{margin-top:14px;}
.evo-branch{background:linear-gradient(180deg,#fff7fb,#fffafc);border-radius:12px;padding:12px;margin-top:12px;border:1px solid rgba(255,210,225,0.8);}
.evo-row{display:flex;align-items:center;gap:16px;flex-wrap:wrap;}
.evo-step{text-align:center;min-width:96px;}
.evo-step img{width:88px;height:88px;border-radius:8px;}
.arrow{font-size:24px;color:#c65a8c;margin:0 8px;}
.evo-bullets{padding-left:20px;margin-top:10px;}
.evo-bullets li{margin-bottom:6px;color:#333;}
.form-label{display:inline-block;margin-top:6px;padding:6px 8px;border-radius:8px;background:#fff0f6;border:1px solid #ffdce9;font-weight:800;}

/* menu/professor bubble */
.prof-bubble{position:absolute;right:28px;top:96px;width:420px;background:linear-gradient(180deg,#fff,#fffaf8);border-radius:14px;border:2px solid rgba(255,220,235,0.95);padding:12px;box-shadow:0 12px 30px rgba(80,40,80,0.08);display:none;z-index:60;}
.prof-row{display:flex;gap:12px;align-items:flex-start;}
.prof-sprite{width:64px;height:64px;border-radius:10px;background:linear-gradient(180deg,#fff,#f6f6f6);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,220,235,0.95);}
.prof-text{font-size:14px;color:#2f2330;text-align:left;}
.menu-toggle{display:flex;gap:8px;align-items:center;margin-top:10px;}

/* map (tabbed) */
.map-panel{position:absolute;left:28px;top:96px;width:520px;max-height:520px;overflow:auto;background:linear-gradient(180deg,#fff,#fffafc);border-radius:12px;border:2px solid rgba(220,235,255,0.9);padding:12px;box-shadow:0 12px 30px rgba(20,40,80,0.08);display:none;z-index:60;}
.map-panel h4{margin:6px 0 8px 0;color:#1b486f;}
.tab-row{display:flex;gap:8px;margin-bottom:8px;}
.tab{padding:8px 12px;border-radius:10px;background:#fff;border:1px solid rgba(200,220,255,0.85);cursor:pointer;font-weight:800;}
.tab.active{background:linear-gradient(180deg,#eaf6ff,#dbefff);box-shadow:0 6px 18px rgba(40,120,210,0.06);}

/* bottom hardware buttons */
.device-controls{width:100%;display:flex;justify-content:center;gap:18px;margin-top:12px;}
.hw-btn{width:118px;height:56px;border-radius:14px;background:linear-gradient(180deg,#fff,#fff0f6);border:2px solid rgba(255,220,235,0.95);box-shadow:0 12px 26px rgba(255,120,170,0.08);display:flex;align-items:center;justify-content:center;font-weight:900;color:#7a2f56;cursor:pointer;}
.hw-btn.toggled{background:linear-gradient(180deg,#ffe6f2,#ffd0ea);box-shadow:0 8px 18px rgba(255,90,160,0.12);}

/* dev gear icon (subtle) */
.dev-gear {
  position:absolute; right:22px; top:18px; width:40px; height:40px; border-radius:10px;
  display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:120;
  background: linear-gradient(180deg,#ffdff0,#ffd0e5); border:2px solid rgba(255,255,255,0.9); box-shadow:0 6px 18px rgba(200,80,140,0.08);
}
.dev-gear svg{width:22px;height:22px; transform-origin:center; transition: transform .28s ease; }
.dev-gear.spin svg{ transform: rotate(180deg); }

/* editor panel (floating) */
.editor-panel {
  position:absolute; right:24px; top:70px; width:320px; max-width:92vw; background:linear-gradient(180deg,#fff,#fff9fb);
  border-radius:12px; padding:12px; box-shadow:0 20px 60px rgba(120,60,100,0.12); border:2px solid rgba(255,220,235,0.95); z-index:200; display:none;
}
.editor-panel h4{margin:6px 0 10px 0;font-size:15px;color:#6b3150;}
.editor-row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;}
.editor-row label{font-size:13px;color:#4b2d3b;font-weight:700;}
.editor-row input[type="range"]{width:140px;}
.editor-row input[type="color"]{width:44px;height:30px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);}
.editor-actions{display:flex;gap:8px;margin-top:8px;}
.editor-actions button{flex:1;padding:8px;border-radius:10px;border:1px solid rgba(200,200,200,0.12);background:#fff;font-weight:800;}

/* mobile tweaks */
@media (max-width:920px){
  .device{width:92vw;height:92vh;padding:12px;border-radius:14px;}
  .screen{height:calc(100% - 170px);padding:12px;}
  .prof-bubble{right:12px;top:86px;width:260px;}
  .map-panel{left:12px;top:86px;width:260px;max-height:40vh;}
  .pokemon-card{width:100%;padding:12px;}
  .images img{width:120px;height:120px;}
  .hw-btn{width:86px;height:44px;font-size:13px;}
  .dev-gear{right:12px; top:12px; width:36px; height:36px;}
  .editor-panel{right:12px; top:58px; width:86vw;}
}
</style>
</head>
<body>
  <div class="device" role="application" aria-label="PokÃ©gear Randomizer ver.10.2">
    <div class="status">
      <div class="left"><span style="font-size:15px;">PokÃ©gear</span> <span style="opacity:.88;font-weight:800;">â€¢ Love Ball â€¢ Hybrid UI</span></div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="signal"><div class="dot t1"></div><div class="dot t2"></div><div class="dot t3"></div></div>
        <div class="battery"><div class="bat-level" style="width:70%;"></div></div>
      </div>
    </div>

    <!-- Dev Gear Icon -->
    <div class="dev-gear" id="devGear" title="Open Developer Editor (appearance & layout)">
      <!-- stylized gear that fits PokÃ©gear look -->
      <svg viewBox="0 0 24 24" fill="none" stroke="#7a2f56" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V20a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H4a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82L5.3 6.46A2 2 0 0 1 8.13 3.63l.06.06a1.65 1.65 0 0 0 1.82.33H10a1.65 1.65 0 0 0 1-1.51V4a2 2 0 0 1 4 0v.09c.12.58.62 1 1.2 1.11.57.11 1.03-.16 1.36-.47l.06-.06A2 2 0 0 1 20.37 8.1l-.06.06c-.17.18-.33.39-.47.62.16.35.27.73.33 1.13z"></path>
      </svg>
    </div>

    <div class="screen" id="screen" role="region" aria-label="Randomizer screen">
      <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
        <h1 class="device-title">PokÃ©mon Randomizer</h1>

        <div class="controls">
          <label for="genSelect" style="font-weight:900;color:#5b3a4a;">Gen</label>
          <select id="genSelect" aria-label="Generation filter">
            <option value="all">All</option>
            <option value="1">Gen 1 (1â€“151)</option>
            <option value="2">Gen 2 (152â€“251)</option>
            <option value="3">Gen 3 (252â€“386)</option>
            <option value="4">Gen 4 (387â€“493)</option>
            <option value="5">Gen 5 (494â€“649)</option>
            <option value="6">Gen 6 (650â€“721)</option>
            <option value="7">Gen 7 (722â€“809)</option>
            <option value="8">Gen 8 (810â€“905)</option>
            <option value="9">Gen 9 (906â€“1025)</option>
          </select>

          <button id="generateBtn" class="generate" title="Roll a random PokÃ©mon">ðŸ’— Roll</button>
        </div>

        <div id="pokemonContainer" style="width:100%;display:flex;align-items:center;justify-content:center;margin-top:18px;"></div>
      </div>

      <!-- MENU / Professor -->
      <div class="prof-bubble" id="profBubble" role="dialog" aria-hidden="true">
        <div class="prof-row">
          <div class="prof-sprite" aria-hidden="true">
            <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#5c3b4e" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 6c1-2 6-3 9 0" fill="#fff0f8"/>
              <circle cx="12" cy="10" r="4" fill="#fff" stroke="#5c3b4e"/>
              <circle cx="10.5" cy="10" r="1.2"/><circle cx="13.5" cy="10" r="1.2"/><path d="M11.7 10h0.6"/><path d="M10 13c1 1 3 1 4 0"/>
              <rect x="7" y="14" width="10" height="8" rx="2" fill="#ffffff" stroke="#5c3b4e"/><path d="M12 14v4" stroke="#ff6aa6"/>
            </svg>
          </div>
          <div style="flex:1;">
            <div class="prof-text" id="profText">Professor's notes will appear here.</div>
            <div class="menu-toggle">
              <label style="font-weight:900;"><input id="factMode" type="checkbox" /> Fun Facts</label>
              <span style="opacity:.8;margin-left:8px;font-size:13px;">(toggle Serious / Fun)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- MAP (Tabbed) -->
      <div class="map-panel" id="mapPanel" role="dialog" aria-hidden="true">
        <h4>Where to find this PokÃ©mon</h4>
        <div class="tab-row">
          <div class="tab active" data-tab="gens" id="tabGens">GENERATIONS</div>
          <div class="tab" data-tab="games" id="tabGames">GAMES</div>
          <div class="tab" data-tab="regions" id="tabRegions">REGIONS</div>
          <div class="tab" data-tab="notes" id="tabNotes">NOTES</div>
        </div>
        <div id="tabContent" class="notes"><p style="opacity:.8">No data yet â€” roll a PokÃ©mon.</p></div>
      </div>

    </div>

    <div style="width:100%;display:flex;justify-content:center;margin-top:12px;">
      <div class="device-controls" role="toolbar" aria-label="Device buttons">
        <div id="menuBtn" class="hw-btn" title="Menu (facts)">MENU</div>
        <div id="mapBtn" class="hw-btn" title="Map (locations)">MAP</div>
        <div id="callBtn" class="hw-btn" title="Call (play cry)">CALL</div>
      </div>
    </div>

    <!-- Editor panel (hidden by default) -->
    <div class="editor-panel" id="editorPanel" aria-hidden="true" role="dialog">
      <h4>PokÃ©gear Editor</h4>

      <div class="editor-row">
        <label>Wallpaper Color</label>
        <input type="color" id="inpBlush" value="#f7bfd6" />
      </div>

      <div class="editor-row">
        <label>Accent Color</label>
        <input type="color" id="inpAccent" value="#ff6aa6" />
      </div>

      <div class="editor-row">
        <label>Dot size</label>
        <input id="inpDotSize" type="range" min="16" max="96" step="1" value="40" />
      </div>

      <div class="editor-row">
        <label>Dot offset</label>
        <input id="inpDotOffset" type="range" min="24" max="160" step="1" value="85" />
      </div>

      <div class="editor-row">
        <label>Wallpaper opacity</label>
        <input id="inpOpacity" type="range" min="0.25" max="1" step="0.05" value="1" />
      </div>

      <div class="editor-row">
        <label>Border radius</label>
        <input id="inpRadius" type="range" min="6" max="60" step="1" value="34" />
      </div>

      <div class="editor-row">
        <label>Font size</label>
        <input id="inpFont" type="range" min="12" max="20" step="1" value="16" />
      </div>

      <div class="editor-actions">
        <button id="saveEditor">Save</button>
        <button id="exportCss">Export CSS</button>
        <button id="resetEditor">Reset</button>
      </div>

      <div style="margin-top:8px;font-size:12px;color:#5b3a4a;">Changes saved locally in your browser (localStorage). Export to copy variable CSS.</div>
    </div>

  </div>

<script>
/* ================== PokÃ©gear ver.10.2 script (with editor) ================== */

/* ---------- Editable internal DBs (short examples, expand as needed) ---------- */
const gameLabels = {
  "red": {name:"Red/Blue/Yellow", gen:1, label:"Gen 1 (RBY)", year:1996, region:"Kanto"},
  "firered": {name:"FireRed/LeafGreen", gen:1.5, label:"Gen 1.5 (FRLG)", year:2004, region:"Kanto"},
  "let's-go-pikachu": {name:"Let's Go Pikachu/Eevee", gen:3.5, label:"Gen 3.5 (Let's Go)", year:2018, region:"Kanto"},
  "legends-arceus": {name:"Legends: Arceus", gen:8.5, label:"Gen 8.5 (Legends: Arceus)", year:2022, region:"Hisui"},
  "scarlet": {name:"Scarlet", gen:9, label:"Gen 9 (Scarlet)", year:2022, region:"Paldea"},
  "violet": {name:"Violet", gen:9, label:"Gen 9 (Violet)", year:2022, region:"Paldea"},
  "legends-z-a": {name:"Legends Z-A", gen:9.5, label:"Gen 9.5 (Legends Z-A)", year:2025, region:"Paldea"},
};

const generationEncounterData = {
  "pikachu": [1,2,3,4,6,7,8,8.5,9],
  "bulbasaur": [1,3,4,6,7,8],
  "sprigatito": [9],
};

const gameAvailability = {
  "pikachu": ["red","firered","let's-go-pikachu","scarlet","violet"],
  "sprigatito": ["scarlet","violet"]
};

const formIntroductions = {
  "kangaskhan-mega": { gen:6, label:"Gen 6 (Mega Evolution era)", year:2013 },
  "growlithe-hisui": { gen:8.5, label:"Gen 8.5 (Legends: Arceus)", year:2022 },
  "meowth-alola": { gen:7, label:"Gen 7 (Sun & Moon â€” Alola)", year:2016 },
};

/* silhoutte small svg */
const SILHOUETTE_SVG = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect fill="#f5e6ef" width="100%" height="100%"/><g fill="#d9bfc8" opacity="0.95"><circle cx="256" cy="200" r="120"/></g></svg>`);

/* utilities */
function capitalize(s){ return s? s.charAt(0).toUpperCase()+s.slice(1):''; }
function safeKey(s){ return (s||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-_]/g,''); }
function pokedbArtworkUrl(name){ return `https://img.pokemondb.net/artwork/${encodeURIComponent(name)}.jpg`; }
function showdownSpriteUrl(name){ return `https://play.pokemonshowdown.com/sprites/gen5/${encodeURIComponent(name)}.png`; }
function prettifyVersionName(v){ if(!v) return v; return (gameLabels[v] && gameLabels[v].name) ? gameLabels[v].name : v.replace(/-/g,' ').replace(/\b\w/g,c=>c.toUpperCase()); }

/* UI refs */
const pokemonContainer = document.getElementById('pokemonContainer');
const profBubble = document.getElementById('profBubble');
const profText = document.getElementById('profText');
const mapPanel = document.getElementById('mapPanel');
const mapContent = document.getElementById('tabContent');
const menuBtn = document.getElementById('menuBtn');
const mapBtn = document.getElementById('mapBtn');
const callBtn = document.getElementById('callBtn');
const factModeCheckbox = document.getElementById('factMode');
const devGear = document.getElementById('devGear');
const editorPanel = document.getElementById('editorPanel');
const saveEditorBtn = document.getElementById('saveEditor');
const exportCssBtn = document.getElementById('exportCss');
const resetEditorBtn = document.getElementById('resetEditor');

/* tab refs */
const tabGens = document.getElementById('tabGens');
const tabGames = document.getElementById('tabGames');
const tabRegions = document.getElementById('tabRegions');
const tabNotes = document.getElementById('tabNotes');

/* app state */
let currentSpeciesData = null;
let currentPokemonData = null;
let currentPokemonName = null;
let audio = null;
let isPlayingCry = false;
const genRanges = {1:[1,151],2:[152,251],3:[252,386],4:[387,493],5:[494,649],6:[650,721],7:[722,809],8:[810,905],9:[906,1025],all:[1,1025]};

/* wire up buttons */
document.getElementById('generateBtn').addEventListener('click', async ()=>{
  const val = document.getElementById('genSelect').value;
  const [min,max] = genRanges[val] || genRanges['all'];
  const id = Math.floor(Math.random()*(max-min+1))+min;
  await loadPokemon(id);
  closeMenu(); closeMap(); stopCry();
});
menuBtn.addEventListener('click', ()=> toggleMenu());
mapBtn.addEventListener('click', ()=> toggleMap());
callBtn.addEventListener('click', ()=> toggleCall());
factModeCheckbox.addEventListener('change', ()=> {
  if(profBubble.style.display === 'block' && currentSpeciesData && currentPokemonData) prepareFacts(currentSpeciesData, currentPokemonData);
});

/* tabs */
function clearActiveTabs(){ [tabGens,tabGames,tabRegions,tabNotes].forEach(t=>t.classList.remove('active')); }
tabGens.addEventListener('click', ()=> { clearActiveTabs(); tabGens.classList.add('active'); renderMapTab('gens');});
tabGames.addEventListener('click', ()=> { clearActiveTabs(); tabGames.classList.add('active'); renderMapTab('games');});
tabRegions.addEventListener('click', ()=> { clearActiveTabs(); tabRegions.classList.add('active'); renderMapTab('regions');});
tabNotes.addEventListener('click', ()=> { clearActiveTabs(); tabNotes.classList.add('active'); renderMapTab('notes');});

/* toggles */
function toggleMenu(){ const show = profBubble.style.display !== 'block'; profBubble.style.display = show ? 'block' : 'none'; menuBtn.classList.toggle('toggled', show); profBubble.setAttribute('aria-hidden', !show); if(show && currentSpeciesData && currentPokemonData) prepareFacts(currentSpeciesData, currentPokemonData); }
function closeMenu(){ profBubble.style.display='none'; menuBtn.classList.remove('toggled'); profBubble.setAttribute('aria-hidden','true'); }
function toggleMap(){ const show = mapPanel.style.display !== 'block'; mapPanel.style.display = show ? 'block' : 'none'; mapBtn.classList.toggle('toggled', show); mapPanel.setAttribute('aria-hidden', !show); if(show && currentSpeciesData && currentPokemonData) renderMapTab('gens'); }
function closeMap(){ mapPanel.style.display='none'; mapBtn.classList.remove('toggled'); mapPanel.setAttribute('aria-hidden','true'); }

async function toggleCall(){ if(!currentPokemonName) return; if(isPlayingCry){ stopCry(); return; } await playCry(currentPokemonName); }
function stopCry(){ if(audio){ audio.pause(); audio.currentTime=0; audio=null;} isPlayingCry=false; callBtn.classList.remove('toggled'); }
async function playCry(name){
  callBtn.classList.add('toggled'); isPlayingCry=true;
  const normalized = safeKey(name);
  const urls = [
    `https://play.pokemonshowdown.com/audio/cries/${normalized}.mp3`,
    `https://play.pokemonshowdown.com/audio/cries/${normalized}.ogg`
  ];
  for(const u of urls){
    try{ if(audio){ audio.pause(); audio=null; } audio = new Audio(u); await audio.play(); audio.onended = ()=>{ isPlayingCry=false; callBtn.classList.remove('toggled'); }; audio.onerror = ()=>{}; return; }
    catch(e){ continue; }
  }
  alert("No game cry found for this PokÃ©mon in the available sources.");
  isPlayingCry=false; callBtn.classList.remove('toggled');
}

/* ---------- Core: load and render PokÃ©mon ---------- */
async function loadPokemon(id){
  pokemonContainer.innerHTML = '<div class="pokemon-card"><p style="opacity:.7">Loading PokÃ©monâ€¦</p></div>';
  try {
    const pRes = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
    if(!pRes.ok) throw new Error('pokemon fetch failed');
    const pData = await pRes.json();
    currentPokemonData = pData; currentPokemonName = pData.name;

    const spRes = await fetch(pData.species.url);
    if(!spRes.ok) throw new Error('species fetch failed');
    const spData = await spRes.json(); currentSpeciesData = spData;

    const entryObj = spData.flavor_text_entries.find(e => e.language.name === 'en');
    const dexEntry = entryObj ? entryObj.flavor_text.replace(/\f/g,' ') : 'No PokÃ©dex entry available.';
    const genus = spData.genera.find(g=>g.language.name==='en')?.genus || '';
    const generationName = spData.generation ? spData.generation.name.replace('generation-','Gen ').toUpperCase() : '';

    const evoRes = await fetch(spData.evolution_chain.url);
    const evoData = await evoRes.json();
    const paths = [];
    (function dfs(node,cur){
      const nm = node.species.name; const details = node.evolution_details || [];
      const newPath = cur.concat([{species:nm, details}]);
      if(!node.evolves_to || node.evolves_to.length===0) paths.push(newPath);
      else node.evolves_to.forEach(ch => dfs(ch, newPath));
    })(evoData.chain,[]);

    const varietyNames = spData.varieties.map(v => v.pokemon.name);
    const speciesSet = new Set(varietyNames);
    paths.forEach(p => p.forEach(n => speciesSet.add(n.species)));
    const fetchList = Array.from(speciesSet);

    // fetch details for all relevant variants
    const fetches = await Promise.all(fetchList.map(async nm=>{
      try{ const r = await fetch(`https://pokeapi.co/api/v2/pokemon/${nm}`); if(!r.ok) return {name:nm, ok:false}; const j = await r.json(); return {name:nm, ok:true, data:j}; }
      catch(e){ return {name:nm, ok:false}; }
    }));
    const pokemonMap = {}; fetches.forEach(f => { if(f.ok) pokemonMap[f.name] = f.data; });

    const varietyMap = {};
    spData.varieties.forEach(v => {
      const nm = v.pokemon.name; const info = pokemonMap[nm];
      varietyMap[nm] = {
        spriteApi: info?.sprites?.other?.['official-artwork']?.front_default || info?.sprites?.front_default || SILHOUETTE_SVG,
        pokedb: pokedbArtworkUrl(nm),
        showdown: showdownSpriteUrl(nm),
        types: info?.types?.map(t=>t.type.name) || [],
        name: info?.name || nm,
        game_indices: info?.game_indices?.map(g=>g.version.name) || []
      };
    });
    for(const nm of fetchList){
      if(!varietyMap[nm]){
        const info = pokemonMap[nm];
        varietyMap[nm] = {
          spriteApi: info?.sprites?.other?.['official-artwork']?.front_default || info?.sprites?.front_default || SILHOUETTE_SVG,
          pokedb: pokedbArtworkUrl(nm),
          showdown: showdownSpriteUrl(nm),
          types: info?.types?.map(t=>t.type.name) || [],
          name: info?.name || nm,
          game_indices: info?.game_indices?.map(g=>g.version.name) || []
        };
      }
    }

    // build evoHTML
    let evoHtml = "";
    if(!paths.length) evoHtml = "<div class='note'>No evolution data.</div>";
    else {
      for(const path of paths){
        evoHtml += `<div class="evo-branch"><div class="evo-row">`;
        for(let i=0;i<path.length;i++){
          const st = path[i]; const info = varietyMap[st.species] || {spriteApi:SILHOUETTE_SVG, name:st.species, types:[]};
          evoHtml += `<div class="evo-step"><img src="${info.pokedb}" data-api="${info.spriteApi}" data-showdown="${info.showdown}" alt="${capitalize(info.name)}" onerror="this.onerror=null;this.src=this.dataset.showdown||this.dataset.api||'${SILHOUETTE_SVG}';" /><div style="font-weight:900;margin-top:8px;">${capitalize(info.name)}</div>`;
          if(info.types && info.types.length){ evoHtml += `<div style="display:flex;gap:6px;justify-content:center;margin-top:6px;">`; info.types.forEach(tt => evoHtml += `<div class="type" style="padding:4px 8px;font-size:12px;">${tt}</div>`); evoHtml += `</div>`; }
          evoHtml += `</div>`; if(i < path.length - 1) evoHtml += `<div class="arrow">â†’</div>`;
        }
        evoHtml += `</div><ul class="evo-bullets">`;
        for(let i=1;i<path.length;i++){
          const from = path[i-1]; const to = path[i]; const descs = describeEvolutionDetails(to.details || []);
          const fromInfo = varietyMap[from.species] || {name:from.species}; const toInfo = varietyMap[to.species] || {name:to.species};
          evoHtml += `<li><strong>${capitalize(fromInfo.name)} â†’ ${capitalize(toInfo.name)}</strong><ul>`; descs.forEach(d => evoHtml += `<li>${d}</li>`); evoHtml += `</ul></li>`;
        }
        if(path.length===1) evoHtml += `<li><em>No evolutions</em></li>`;
        evoHtml += `</ul></div>`;
      }
    }

    // forms
    const altVarieties = spData.varieties.filter(v => v.pokemon.name !== (spData.varieties.find(x=>x.is_default)?.pokemon.name || spData.name));
    let formsHtml = "";
    if(altVarieties.length){
      formsHtml += `<div style="margin-top:12px;"><h4 style="margin:6px 0;">Forms & Regional Variant Lines</h4>`;
      for(const v of altVarieties){
        const nm = v.pokemon.name; const info = varietyMap[nm] || {spriteApi:SILHOUETTE_SVG,pokedb:pokedbArtworkUrl(nm),showdown:showdownSpriteUrl(nm), types:[], name:nm};
        const parts = nm.split('-'); const suffix = parts.length>1 ? parts.slice(1).join('-') : null; const base = parts[0];
        let matched = false;
        for(const path of paths){
          for(let i=0;i<path.length;i++){
            if(path[i].species === base){
              if(i < path.length - 1){
                const next = path[i+1].species;
                const targetVariant = `${next}${suffix ? '-' + suffix : ''}`;
                if(varietyMap[targetVariant]){
                  const baseVar = varietyMap[nm]; const nextVar = varietyMap[targetVariant];
                  formsHtml += `<div class="evo-branch"><div class="evo-row">`;
                  formsHtml += `<div class="evo-step"><img src="${baseVar.pokedb}" data-api="${baseVar.spriteApi}" data-showdown="${baseVar.showdown}" alt="${capitalize(baseVar.name)}" onerror="this.onerror=null;this.src=this.dataset.showdown||this.dataset.api||'${SILHOUETTE_SVG}';" /><div style="font-weight:900;margin-top:8px;">${capitalize(baseVar.name)}</div>`;
                  if(baseVar.types && baseVar.types.length){ formsHtml += `<div style="display:flex;gap:6px;justify-content:center;margin-top:6px;">`; baseVar.types.forEach(tt=>formsHtml+=`<div class="type" style="padding:4px 8px;font-size:12px;">${tt}</div>`); formsHtml += `</div>`; }
                  formsHtml += `</div><div class="arrow">â†’</div>`;
                  formsHtml += `<div class="evo-step"><img src="${nextVar.pokedb}" data-api="${nextVar.spriteApi}" data-showdown="${nextVar.showdown}" alt="${capitalize(nextVar.name)}" onerror="this.onerror=null;this.src=this.dataset.showdown||this.dataset.api||'${SILHOUETTE_SVG}';" /><div style="font-weight:900;margin-top:8px;">${capitalize(nextVar.name)}</div>`;
                  if(nextVar.types && nextVar.types.length){ formsHtml += `<div style="display:flex;gap:6px;justify-content:center;margin-top:6px;">`; nextVar.types.forEach(tt=>formsHtml+=`<div class="type" style="padding:4px 8px;font-size:12px;">${tt}</div>`); formsHtml += `</div>`; }
                  formsHtml += `</div></div>`;
                  const intro = formIntroductions[nm]; if(intro) formsHtml += `<div style="margin-top:8px;padding-left:8px;"><em>Introduced in: Gen ${intro.gen} (${intro.label}, ${intro.year})</em></div>`;
                  else formsHtml += `<div style="margin-top:8px;padding-left:8px;"><em>Introduced in: ${spData.generation ? spData.generation.name.replace('generation-','Gen ').toUpperCase() : 'Unknown'}</em></div>`;
                  formsHtml += `</div>`;
                  matched = true; break;
                }
              }
            }
          }
          if(matched) break;
        }
        if(!matched){
          const intro = formIntroductions[nm];
          formsHtml += `<div class="evo-branch"><div style="display:flex;gap:12px;align-items:center;"><div style="width:96px;text-align:center;"><img src="${info.pokedb}" data-api="${info.spriteApi}" data-showdown="${info.showdown}" alt="${capitalize(info.name)}" onerror="this.onerror=null;this.src=this.dataset.showdown||this.dataset.api||'${SILHOUETTE_SVG}';" style="width:84px;height:84px;border-radius:8px;" /></div><div style="flex:1;"><div style="font-weight:900">${capitalize(info.name)}</div>`;
          if(info.types && info.types.length){ formsHtml += `<div style="display:flex;gap:8px;margin-top:6px;">`; info.types.forEach(tt=>formsHtml+=`<div class="type" style="padding:4px 8px;font-size:12px;">${tt}</div>`); formsHtml += `</div>`; }
          if(intro) formsHtml += `<div style="margin-top:8px;"><em>Introduced in: Gen ${intro.gen} (${intro.label}, ${intro.year})</em></div>`;
          else formsHtml += `<div style="margin-top:8px;"><em>Introduced in: ${spData.generation ? spData.generation.name.replace('generation-','Gen ').toUpperCase() : 'Unknown'}</em></div>`;
          formsHtml += `</div></div></div>`;
        }
      }
      formsHtml += `</div>`;
    }

    const styleMarkers = ['cosplay','style','ordinary','school','player','attack','defense','speed','land','fan','base','therian','totem','g-max','gmax'];
    const styleList = spData.varieties.filter(v=>{
      const nm = v.pokemon.name; if(!nm.includes('-')) return false;
      return styleMarkers.some(m => nm.includes(m));
    });
    let stylesHtml = "";
    if(styleList.length){
      stylesHtml += `<div style="margin-top:12px;"><h4 style="margin:6px 0;">Styles & Costumes (logged)</h4>`;
      styleList.forEach(sv=>{
        const nm = sv.pokemon.name; const info = varietyMap[nm] || {spriteApi:SILHOUETTE_SVG,pokedb:pokedbArtworkUrl(nm),showdown:showdownSpriteUrl(nm), name:nm};
        const intro = formIntroductions[nm];
        stylesHtml += `<div style="display:flex;gap:12px;align-items:center;margin-top:8px;"><img src="${info.pokedb}" data-api="${info.spriteApi}" data-showdown="${info.showdown}" alt="${capitalize(info.name)}" onerror="this.onerror=null;this.src=this.dataset.showdown||this.dataset.api||'${SILHOUETTE_SVG}';" style="width:64px;height:64px;border-radius:8px;"><div><strong>${capitalize(info.name)}</strong><div style="margin-top:6px;"><em>Style introduced: ${intro ? `Gen ${intro.gen} (${intro.label}, ${intro.year})` : (spData.generation ? spData.generation.name.replace('generation-','Gen ').toUpperCase() : 'Unknown')}</em></div></div></div>`;
      });
      stylesHtml += `</div>`;
    }

    // final assembly
    const typesHtml = pData.types.map(t => `<div class="type">${t.type.name}</div>`).join('');
    const artImgTag = `<img src="${pokedbArtworkUrl(pData.name)}" data-api="${pData.sprites.other?.['official-artwork']?.front_default || SILHOUETTE_SVG}" data-showdown="${showdownSpriteUrl(pData.name)}" alt="${capitalize(pData.name)}" onerror="this.onerror=null;this.src=this.dataset.showdown||this.dataset.api||'${SILHOUETTE_SVG}';" />`;
    pokemonContainer.innerHTML = `
      <div class="pokemon-card" role="region" aria-label="PokÃ©mon card">
        <h2 style="margin:6px 0;font-size:24px;">#${currentPokemonData.id} ${capitalize(currentPokemonData.name)}</h2>
        <p style="margin:0;color:#6a3b52;font-weight:800;">${genus}</p>
        <div class="images">
          ${artImgTag}
          <img src="${pokedbArtworkUrl(pData.name)}" data-api="${pData.sprites.other?.['official-artwork']?.front_shiny || SILHOUETTE_SVG}" data-showdown="${showdownSpriteUrl(pData.name)}" alt="${capitalize(pData.name)} shiny" class="small-img" onerror="this.onerror=null;this.src=this.dataset.showdown||this.dataset.api||'${SILHOUETTE_SVG}';" />
        </div>
        <div style="display:flex;align-items:center;gap:12px;flex-direction:row;justify-content:center;margin-top:8px;">
          <div class="generation-badge">${generationName}</div>
        </div>
        <div class="info">
          <div class="types">${typesHtml}</div>
          <div class="dex-entry">${dexEntry}</div>
          <div class="evolutions"><h4 style="margin:8px 0 6px 0;">Evolution Line</h4>${evoHtml}</div>
          ${formsHtml}
          ${stylesHtml}
        </div>
      </div>
    `;
    
    prepareFacts(spData, pData);

  } catch(err){
    console.error(err);
    pokemonContainer.innerHTML = `<div class="pokemon-card"><p style="opacity:.8">Unable to load PokÃ©mon data. Try again.</p></div>`;
  }
}

/* humanize evolution details */
function describeEvolutionDetails(details){
  if(!details || details.length===0) return ['No special conditions'];
  const out = [];
  details.forEach(d=>{
    const t = d.trigger?.name; const parts = [];
    if(t === 'level-up'){
      if(d.min_level) parts.push(`Level ${d.min_level}`);
      else if(d.min_happiness) parts.push('High Friendship');
      else if(d.min_affection) parts.push('High Affection');
      else if(d.min_beauty) parts.push('High Beauty');
      else parts.push('Level up');
      if(d.time_of_day) parts.push(`${capitalize(d.time_of_day)} only`);
      if(d.gender === 1) parts.push('Female only');
      if(d.gender === 2) parts.push('Male only');
      if(d.known_move) parts.push(`Knows ${d.known_move.name}`);
      if(d.known_move_type) parts.push(`Knows a ${d.known_move_type.name}-type move`);
      if(d.location) parts.push(`At ${d.location.name}`);
      if(d.party_species) parts.push(`With ${capitalize(d.party_species.name)} in party`);
      if(d.party_type) parts.push(`With party ${d.party_type.name}-type`);
    } else if(t === 'use-item'){
      if(d.item) parts.push(`Use ${d.item.name.replace(/-/g,' ')}`);
    } else if(t === 'trade'){
      parts.push('Trade');
      if(d.held_item) parts.push(`while holding ${d.held_item.name.replace(/-/g,' ')}`);
      if(d.trade_species) parts.push(`trade for ${d.trade_species.name}`);
    } else {
      if(t) parts.push(capitalize(t.replace(/-/g,' ')));
    }
    out.push(parts.length ? parts.join(', ') : 'Special conditions');
  });
  return Array.from(new Set(out));
}

/* ---------- MAP rendering (tabbed) ---------- */
function renderMapTab(which){
  if(!currentSpeciesData || !currentPokemonData){ mapContent.innerHTML = '<p style="opacity:.8">No data yet â€” roll a PokÃ©mon.</p>'; return; }
  const speciesName = currentSpeciesData.name; const pokemonName = currentPokemonData.name;
  const internalGens = generationEncounterData[pokemonName] || generationEncounterData[speciesName] || [];
  fetch(`https://pokeapi.co/api/v2/pokemon/${currentPokemonData.id}`)
    .then(r=>r.ok? r.json(): null)
    .then(j=>{
      const versions = (j?.game_indices||[]).map(g=>g.version.name).filter(Boolean); const uniqueVersions = Array.from(new Set(versions));
      const genSet = new Set(internalGens);
      uniqueVersions.forEach(v=>{ if(gameLabels[v] && gameLabels[v].gen) genSet.add(gameLabels[v].gen); });
      if(currentSpeciesData.generation){ const gnum = currentSpeciesData.generation.name.replace('generation-',''); if(!isNaN(parseInt(gnum))) genSet.add(parseInt(gnum)); }
      const gensArray = Array.from(genSet).sort((a,b)=>a-b);

      if(which === 'gens'){
        if(gensArray.length === 0){ mapContent.innerHTML = '<p style="opacity:.8">No generation data available.</p>'; return; }
        let html = '<div>';
        gensArray.forEach(g=>{
          const labels = Object.values(gameLabels).filter(x=>x.gen===g).map(x=>`${x.label} (${x.year})`);
          if(labels.length) html += `<div style="margin-bottom:6px;"><strong>Gen ${g}:</strong> ${labels.join(' / ')}</div>`;
          else html += `<div style="margin-bottom:6px;"><strong>Gen ${g}</strong></div>`;
        });
        html += '</div>'; mapContent.innerHTML = html;
      } else if(which === 'games'){
        const internalGames = gameAvailability[pokemonName] || gameAvailability[speciesName] || [];
        let html = '';
        if(internalGames.length){
          html += `<div><strong>Manual entries:</strong><ul>`;
          internalGames.forEach(k => { const lbl = gameLabels[k] ? `${gameLabels[k].name} (${gameLabels[k].label}, ${gameLabels[k].year})` : k; html += `<li>${lbl}</li>`; });
          html += `</ul></div>`;
        }
        if(uniqueVersions.length){
          html += `<div><strong>PokeAPI indices:</strong><ul>`; uniqueVersions.forEach(v => html += `<li>${prettifyVersionName(v)}</li>`); html += `</ul></div>`;
        }
        if(!internalGames.length && !uniqueVersions.length) html += '<p style="opacity:.8">No game data. Add manual entries to internal DB for full coverage.</p>';
        mapContent.innerHTML = html;
      } else if(which === 'regions'){
        const regions = new Set();
        gensArray.forEach(g => { Object.values(gameLabels).forEach(x=>{ if(x.gen === g && x.region) regions.add(x.region); }); });
        if(regions.size === 0) mapContent.innerHTML = '<p style="opacity:.8">No region data available.</p>';
        else mapContent.innerHTML = `<div><strong>Regions:</strong><ul>${Array.from(regions).map(r=>`<li>${r}</li>`).join('')}</ul></div>`;
      } else if(which === 'notes'){
        const notes = []; const internalGames = gameAvailability[pokemonName] || gameAvailability[speciesName] || [];
        if(internalGames.some(g => typeof g === 'string' && g.toLowerCase().includes('home'))) notes.push('Some entries available via PokÃ©mon HOME transfer only.');
        if(uniqueVersions.length === 0 && internalGames.length === 0) notes.push('No explicit game availability data. This is common for very new or event-only PokÃ©mon.');
        if(notes.length) mapContent.innerHTML = `<div><strong>Notes:</strong><ul>${notes.map(n=>`<li>${n}</li>`).join('')}</ul></div>`;
        else mapContent.innerHTML = '<p style="opacity:.8">No special notes for this PokÃ©mon.</p>';
      }
    }).catch(e => { mapContent.innerHTML = '<p style="opacity:.8">Unable to build MAP data (network or API error).</p>'; });
}

/* ---------- Facts ---------- */
function prepareFacts(speciesData, pokemonData){
  const showFun = !!factModeCheckbox.checked; if(showFun) prepareFunFacts(speciesData,pokemonData); else prepareSeriousFacts(speciesData,pokemonData);
}
function prepareSeriousFacts(speciesData,pokemonData){
  const name = capitalize(pokemonData.name);
  const types = pokemonData.types.map(t => t.type.name);
  const abilities = (pokemonData.abilities||[]).map(a => a.ability.name + (a.is_hidden ? ' (Hidden)' : ''));
  const eggGroups = speciesData.egg_groups?.map(g => g.name) || [];
  const habitat = speciesData.habitat?.name || 'Unknown';
  const gen = speciesData.generation?.name ? speciesData.generation.name.replace('generation-','Gen ').toUpperCase() : 'Unknown';
  const height = pokemonData.height ? `${pokemonData.height/10} m` : 'Unknown';
  const weight = pokemonData.weight ? `${pokemonData.weight/10} kg` : 'Unknown';
  let html = `<div style="font-size:14px;color:#2e2e2e;"><strong>${name}</strong><ul style="margin-top:8px;">`;
  if(types.length) html += `<li>Type: ${types.map(t=>capitalize(t)).join(' / ')}</li>`;
  if(abilities.length) html += `<li>Abilities: ${abilities.map(a=>a.replace(/-/g,' ')).join(', ')}</li>`;
  if(eggGroups.length) html += `<li>Egg group(s): ${eggGroups.map(g=>capitalize(g)).join(', ')}</li>`;
  html += `<li>Height / Weight: ${height} / ${weight}</li>`;
  html += `<li>Habitat (game lore): ${capitalize(habitat)}</li>`;
  html += `<li>Introduced: ${gen}</li>`;
  html += `</ul></div>`;
  profText.innerHTML = html;
}
function prepareFunFacts(speciesData,pokemonData){
  const name = capitalize(pokemonData.name);
  const types = pokemonData.types.map(t => t.type.name);
  const signature = generateSignature(name, types[0] || 'normal');
  const bonus = generateBonus(name, types[0] || 'normal');
  profText.innerHTML = `<strong>Professor (fun):</strong><div style="margin-top:8px;"><em>${signature}</em><br><small style="display:block;margin-top:6px;color:#6a3b52;">Bonus: ${bonus}</small></div>`;
}
function generateSignature(name, base){ const pools={ normal:[`${name} keeps a strict nap schedule.`,`${name} collects shiny things politely.`], ghost:[`${name} sometimes misplaces time.`,`${name} leaves little notes in pockets.`], fire:[`${name} toasts marshmallows with a stare.`], water:[`${name} hums to passing boats.`], grass:[`${name} tucks sunlight into jars.`], default:[`${name} once tried to befriend a lamppost.`] }; const list = pools[base]||pools.default; return list[Math.abs(hashCode(name))%list.length]; }
function generateBonus(name,type){ const pool={ fire:[`${name} is fond of warm socks.`], water:[`${name} hums to boats.`], default:[`${name} once enrolled in an etiquette seminar.`] }; const arr = pool[type]||pool.default; return arr[Math.abs(hashCode(name+type))%arr.length]; }
function hashCode(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return h; }

/* ---------- Editor: apply, save, export ---------- */
const inpBlush = document.getElementById('inpBlush'), inpAccent = document.getElementById('inpAccent'),
      inpDotSize = document.getElementById('inpDotSize'), inpDotOffset = document.getElementById('inpDotOffset'),
      inpOpacity = document.getElementById('inpOpacity'), inpRadius = document.getElementById('inpRadius'),
      inpFont = document.getElementById('inpFont');

function applyEditorValues(vals){
  if(vals.blush) document.documentElement.style.setProperty('--blush', vals.blush);
  if(vals.accent) document.documentElement.style.setProperty('--accent', vals.accent);
  if(vals.dotSize) document.documentElement.style.setProperty('--dot-size', vals.dotSize + 'px');
  if(vals.dotOffset) document.documentElement.style.setProperty('--dot-offset', vals.dotOffset + 'px');
  if(vals.opacity != null) document.documentElement.style.setProperty('--wallpaper-opacity', vals.opacity);
  if(vals.radius) document.documentElement.style.setProperty('--border-radius', vals.radius + 'px');
  if(vals.fontSize) document.documentElement.style.setProperty('--font-base', vals.fontSize + 'px');
}
function readEditorValues(){
  return {
    blush: inpBlush.value,
    accent: inpAccent.value,
    dotSize: parseInt(inpDotSize.value,10),
    dotOffset: parseInt(inpDotOffset.value,10),
    opacity: parseFloat(inpOpacity.value),
    radius: parseInt(inpRadius.value,10),
    fontSize: parseInt(inpFont.value,10)
  };
}
function saveEditorToLocal(){
  const vals = readEditorValues();
  localStorage.setItem('pokegear_editor_v102', JSON.stringify(vals));
  applyEditorValues(vals);
  alert('Editor settings saved locally.');
}
function loadEditorFromLocal(){
  const raw = localStorage.getItem('pokegear_editor_v102');
  if(raw){ try{ const vals = JSON.parse(raw); inpBlush.value = vals.blush||'#f7bfd6'; inpAccent.value = vals.accent||'#ff6aa6'; inpDotSize.value = vals.dotSize||40; inpDotOffset.value = vals.dotOffset||85; inpOpacity.value = vals.opacity||1; inpRadius.value = vals.radius||34; inpFont.value = vals.fontSize||16; applyEditorValues(vals); } catch(e){ console.warn('editor load failed', e); } }
}
function exportCssVariables(){
  const vals = readEditorValues();
  const css = `:root{\n  --blush: ${vals.blush};\n  --accent: ${vals.accent};\n  --dot-size: ${vals.dotSize}px;\n  --dot-offset: ${vals.dotOffset}px;\n  --wallpaper-opacity: ${vals.opacity};\n  --border-radius: ${vals.radius}px;\n  --font-base: ${vals.fontSize}px;\n}`;
  navigator.clipboard.writeText(css).then(()=> alert('CSS variables copied to clipboard.'), ()=> alert('Copy failed â€” you can still see variables in console.'), console.log(css));
}
function resetEditorDefaults(){
  const defaults = {blush:'#f7bfd6', accent:'#ff6aa6', dotSize:40, dotOffset:85, opacity:1, radius:34, fontSize:16};
  inpBlush.value = defaults.blush; inpAccent.value = defaults.accent; inpDotSize.value = defaults.dotSize;
  inpDotOffset.value = defaults.dotOffset; inpOpacity.value = defaults.opacity; inpRadius.value = defaults.radius; inpFont.value = defaults.fontSize;
  applyEditorValues(defaults); localStorage.removeItem('pokegear_editor_v102'); alert('Editor reset to defaults.');
}

/* Editor events */
devGear.addEventListener('click', (e)=>{ e.stopPropagation(); const open = editorPanel.style.display !== 'block'; document.getElementById('devGear').classList.toggle('spin', open); editorPanel.style.display = open ? 'block' : 'none'; editorPanel.setAttribute('aria-hidden', !open); if(open) loadEditorFromLocal(); });
document.addEventListener('click', (e)=>{ if(!editorPanel.contains(e.target) && !devGear.contains(e.target)){ editorPanel.style.display = 'none'; devGear.classList.remove('spin'); }});
saveEditorBtn.addEventListener('click', ()=> saveEditorToLocal());
exportCssBtn.addEventListener('click', ()=> exportCssVariables());
resetEditorBtn.addEventListener('click', ()=> resetEditorDefaults());

/* live preview while sliding inputs */
[inpBlush, inpAccent, inpDotSize, inpDotOffset, inpOpacity, inpRadius, inpFont].forEach(el => {
  el.addEventListener('input', ()=> {
    const vals = readEditorValues(); applyEditorValues(vals);
  });
});

/* ---------- init: load editor values & default PokÃ©mon ---------- */
loadEditorFromLocal();
(async ()=>{ try{ await loadPokemon(25); } catch(e){ console.warn('initial load failed', e); } })();

</script>
</body>
</html>

